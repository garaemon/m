<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="keymap-table.html">

<dom-module id="keybind-manager">
  <template>
    <style>
     paper-dialog {
       width: 400px;
     }
    </style>

    <paper-dialog id="helpDialog">
      <h2>Keybind</h2>
      <paper-dialog-scrollable>
        <keymap-table keymap="[[keymap]]"
                      keymap-discription="[[keymapDiscription]]">
        </keymap-table>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Close</paper-button>
      </div>
    </paper-dialog>

  </template>
  <script>
   Polymer({
     is: 'keybind-manager',

     properties: {
       keymap: {
         type: Object,
         value: {
           'j': '_scrollDownOneLine',
           'k': '_scrollUpOneLine',
           'C+n': '_scrollDownOneLine',
           'C+p': '_scrollUpOneLine',
           'h': '_showKeybindHelp',
           '?': '_showKeybindHelp',
           'S+?': '_showKeybindHelp',
         },
       },

       keymapDiscription: {
         type: Object,
         value: {
           '_scrollDownOneLine': 'Scroll down',
           '_scrollUpOneLine': 'Scroll up',
           '_showKeybindHelp': 'Show help',
         },
       },

       scrollLineHeight: {
         type: Number,
         value: 20,
       },

       isMetaPressed: {
         type: Boolean,
       },

       isShiftPressed: {
         type: Boolean,
       },

       isControlPressed: {
         type: Boolean,
       },

       isTabPressed: {
         type: Boolean,
       },

     },

     ready: function() {
       document.onkeydown = (e) => {
         this.handleModifierKeyDown(e.key);
         this.callKeybindCallback(e.key);
       };
       document.onkeyup = (e) => {
         this.handleModifierKeyUp(e.key);
       };
     },

     _handleModifierKey: function(key, value) {
       if (key == 'Meta') {
         this.isMetaPressed = value;
       } else if (key == 'Control') {
         this.isControlPressed = value;
       } else if (key == 'Shift') {
         this.isShiftPressed = value;
       } else if (key == 'Tab') {
         this.isTabPressed = value;
       }
     },

     handleModifierKeyDown: function(key) {
       this._handleModifierKey(key, true);
     },

     handleModifierKeyUp: function(key) {
       this._handleModifierKey(key, false);
     },

     _getKeybindcallbackfunctionInternal: function(key) {
       if (_.has(this.keymap, key)) {
         if (this.keymap[key] in this) {
           return this[this.keymap[key]];
         }
       }
       return null;
     },

     _isModifierKeyPressed: function() {
       return this.isMetaPressed || this.isControlPressed ||
              this.isShiftPressed || this.isTabPressed;
     },

     _addModifierKey: function(key) {
       if (this.isMetaPressed) {
         return `M+${key}`;
       } else if (this.isControlPressed) {
         return `C+${key}`;
       } else if (this.isShiftPressed) {
         return 'S+${key}';
       } else if (this.isTabPressed) {
         return `T+${key}`;
       } else {
         throw new Error('meta key is not pressed');
       }
     },

     getKeybindCallbackFunction: function(key) {
       if (this._isModifierKeyPressed()) {
         const keyWithModifier = this._addModifierKey(key);
         return this._getKeybindcallbackfunctionInternal(keyWithModifier);
       } else {
         return this._getKeybindcallbackfunctionInternal(key);
       }
     },

     callKeybindCallback: function(key) {
       const callback = this.getKeybindCallbackFunction(key);
       if (callback) {
         callback.call(this);
       }
     },

     _scrollDownOneLine: function() {
       window.scrollTo(window.scrollX, window.scrollY + this.scrollLineHeight);
     },

     _scrollUpOneLine: function() {
       window.scrollTo(window.scrollX, window.scrollY - this.scrollLineHeight);
     },

     _showKeybindHelp: function() {
       this.$.helpDialog.toggle();
     },
   });
  </script>
</dom-module>
